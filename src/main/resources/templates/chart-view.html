<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualização de Gráficos</title>
  <!-- Tailwind CSS para um estilo moderno -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #1a202c;
      color: #e2e8f0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1.5rem;
    }

    .container {
      backdrop-filter: blur(10px);
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card {
      background-color: #2d3748;
    }

    /* Estilo para simular o carregamento (esqueleto) */
    .skeleton {
      animation: skeleton-loading 1s linear infinite alternate;
    }

    @keyframes skeleton-loading {
      0% {
        background-color: hsl(210, 5%, 25%);
      }

      100% {
        background-color: hsl(210, 5%, 35%);
      }
    }
  </style>
  <!-- Inclui a biblioteca Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="p-6">
  <!-- Seção principal do painel -->
  <div id="dashboard-container" class="container rounded-2xl p-6 md:p-12 w-full max-w-5xl shadow-xl">
    <div class="flex flex-col md:flex-row justify-between items-center mb-8">
      <a href="choice.html"
        class="py-2 px-4 rounded-lg bg-gray-600 text-white font-semibold hover:bg-gray-700 transition duration-300 mb-4 md:mb-0">
        Voltar
      </a>
      <h1 class="text-3xl md:text-4xl font-bold text-white text-center flex-grow">Gráficos de Sensores</h1>
      <button id="logout-button"
        class="py-2 px-4 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition duration-300">
        Sair
      </button>
    </div>

    <!-- Gráfico em tempo real para Temperatura e Umidade -->
    <div class="card p-6 rounded-2xl shadow-lg mb-6 h-96">
      <h2 class="text-xl font-bold mb-4">Dados em Tempo Real</h2>
      <canvas id="realtime-chart"></canvas>
    </div>

    <!-- Seção de cards de dados, ocultada nesta tela para focar no gráfico -->
    <!-- Você pode copiar e colar os cards aqui se desejar um layout diferente -->
  </div>

  <script>
    // Mapeamento dos tipos de sensores para seus respectivos IDs de HTML.
    const sensorMap = {
      "temperatura": {
        valueId: "temp-value",
        sourceId: "temp-source"
      },
      "umidade": {
        valueId: "humidity-value",
        sourceId: "humidity-source"
      },
      "luminosidade": {
        valueId: "light-value",
        sourceId: "light-source"
      },
    };

    let realtimeChart; // Variável para o gráfico
    const maxDataPoints = 15; // Define o número máximo de pontos a serem exibidos no gráfico

    // Verificação de autenticação e início dos intervalos ao carregar a página
    window.onload = function () {
      const jwtToken = localStorage.getItem('jwtToken');
      if (!jwtToken) {
        // Se não houver token, redireciona para a página de login
        window.location.href = 'login.html';
        return;
      }

      // Inicializa o gráfico
      initializeChart();

      // Inicia o carregamento de dados do backend (simulado)
      fetchSensorData();

      // Atualiza os dados do backend (simulado) a cada 5 segundos
      setInterval(fetchSensorData, 5000);
    };

    // Lógica para o botão de logout
    document.getElementById('logout-button').addEventListener('click', () => {
      // Remove o token e redireciona para o login
      localStorage.removeItem('jwtToken');
      window.location.href = 'login.html';
    });

    // FUNÇÃO DE SIMULAÇÃO - SUBSTITUI A CHAMADA AO BACKEND
    async function fetchSensorData() {
      try {
        // Simula uma resposta de dados para Temperatura e Umidade
        const dataTemp = {
          sensor: "temperatura",
          valor: (Math.random() * (30 - 20) + 20).toFixed(1), // Simula temperatura entre 20 e 30
          source: "Simulado"
        };
        const dataHumidity = {
          sensor: "umidade",
          valor: (Math.random() * (80 - 40) + 40).toFixed(1), // Simula umidade entre 40 e 80
          source: "Simulado"
        };

        // Atualiza o gráfico com os dados simulados
        updateChart('temperatura', parseFloat(dataTemp.valor));
        updateChart('umidade', parseFloat(dataHumidity.valor));

      } catch (error) {
        console.error("Erro na simulação de dados:", error);
      }
    }

    // Inicializa o gráfico
    function initializeChart() {
      const ctx = document.getElementById('realtime-chart').getContext('2d');
      realtimeChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [], // Labels de tempo
          datasets: [{
            label: 'Temperatura (°C)',
            data: [],
            borderColor: '#f87171',
            backgroundColor: 'rgba(248, 113, 113, 0.2)',
            tension: 0.1,
            fill: false
          }, {
            label: 'Umidade (%)',
            data: [],
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96, 165, 250, 0.2)',
            tension: 0.1,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#e2e8f0'
              }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#e2e8f0'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#e2e8f0'
              }
            }
          }
        }
      });
    }

    // Adiciona um novo ponto de dados ao gráfico com "janela deslizante"
    function updateChart(sensor, value) {
      const now = new Date();
      const timeLabel = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

      // Encontra o dataset correto e adiciona o novo valor
      const dataset = realtimeChart.data.datasets.find(ds => ds.label.includes(sensor === 'temperatura' ? 'Temperatura' : 'Umidade'));
      if (dataset) {
        dataset.data.push(value);
      }

      // Atualiza o label de tempo se houver espaço
      if (realtimeChart.data.labels.length < maxDataPoints) {
        realtimeChart.data.labels.push(timeLabel);
      }

      // Remove os pontos mais antigos
      if (realtimeChart.data.labels.length > maxDataPoints) {
        realtimeChart.data.labels.shift();
        realtimeChart.data.datasets[0].data.shift();
        realtimeChart.data.datasets[1].data.shift();
      }

      realtimeChart.update();
    }
  </script>
</body>

</html>