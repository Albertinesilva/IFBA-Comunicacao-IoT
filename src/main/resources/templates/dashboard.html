<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel IoT</title>
  <!-- Tailwind CSS para um estilo moderno e responsivo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #1a202c;
      color: #e2e8f0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1.5rem;
    }

    .container {
      backdrop-filter: blur(10px);
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card {
      background-color: #2d3748;
      transition: transform 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    /* Estilo para simular o carregamento (esqueleto) */
    .skeleton {
      animation: skeleton-loading 1s linear infinite alternate;
    }

    @keyframes skeleton-loading {
      0% {
        background-color: hsl(210, 5%, 25%);
      }

      100% {
        background-color: hsl(210, 5%, 35%);
      }
    }
  </style>
</head>

<body class="p-6">
  <!-- Seção principal do painel -->
  <div id="dashboard-container" class="container rounded-2xl p-6 md:p-12 w-full max-w-5xl shadow-xl">
    <div class="flex flex-col md:flex-row justify-between items-center mb-8">
      <a href="choice.html"
        class="py-2 px-4 rounded-lg bg-gray-600 text-white font-semibold hover:bg-gray-700 transition duration-300 mb-4 md:mb-0">
        Voltar
      </a>
      <h1 class="text-3xl md:text-4xl font-bold text-white text-center flex-grow">Painel de Sensores IoT</h1>
      <button id="logout-button"
        class="py-2 px-4 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition duration-300">
        Sair
      </button>
    </div>

    <!-- Área de Alerta (inicialmente oculta) -->
    <div id="alert-message" class="bg-red-500 text-white p-4 rounded-lg text-center font-semibold mb-6 hidden">
    </div>

    <!-- Layout em grid para os cards de sensores -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

      <!-- Card de Temperatura -->
      <div class="card p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Temperatura</h2>
          <!-- Ícone de termômetro SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-400" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M10 3a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0V3zM8 7a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0V7zM14 7a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0V7zM12 21a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0v-1zM16 21a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0v-1zM18 19h-2v2h2v-2zM6 19H4v2h2v-2zM12 5a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0V5zM16 5a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0V5zM12 9a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0V9zM16 9a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0V9zM12 13a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0v-1zM16 13a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0v-1zM12 17a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0v-1zM16 17a1 1 0 0 1 2 0v1a1 1 0 1 1-2 0v-1z" />
          </svg>
        </div>
        <div class="text-4xl font-semibold mb-2">
          <span id="temp-value" class="skeleton w-24 h-10 inline-block"></span>
          <span class="ml-2">°C</span>
        </div>
        <p class="text-sm text-gray-400">Atualizado a cada 5 segundos</p>
      </div>

      <!-- Card de Umidade -->
      <div class="card p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Umidade</h2>
          <!-- Ícone de gota de água SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 2c-3.11 0-5.64 2.37-6 5.37C5.54 11.55 12 22 12 22s6.46-10.45 6-14.63C17.64 4.37 15.11 2 12 2zm0 13c-1.1 0-2-0.9-2-2s0.9-2 2-2 2 0.9 2 2-0.9 2-2 2z" />
          </svg>
        </div>
        <div class="text-4xl font-semibold mb-2">
          <span id="humidity-value" class="skeleton w-24 h-10 inline-block"></span>
          <span class="ml-2">%</span>
        </div>
        <p class="text-sm text-gray-400">Atualizado a cada 5 segundos</p>
      </div>

      <!-- Card de Luminosidade -->
      <div class="card p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Luminosidade </h2>
          <!-- Ícone de sol SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-400" viewBox="0 0 24 24"
            fill="currentColor">
            <path
              d="M12 2.5c-5.25 0-9.5 4.25-9.5 9.5s4.25 9.5 9.5 9.5 9.5-4.25 9.5-9.5-4.25-9.5-9.5-9.5zm-1 16.5v-2h2v2h-2zm-3.5-3.5l1.41-1.41 1.06 1.06-1.41 1.41-1.06-1.06zm-1.09-2.09l-1.41-1.41-1.06 1.06 1.41 1.41 1.06-1.06zm-1.41-3.5l-2-2v-2h2v-2l2 2-2 2zM12 4v2h2V4h-2zm-1.06 1.06l-1.41-1.41 1.06-1.06 1.41 1.41-1.06 1.06zm-3.5 3.5l-2-2-1.41 1.41 2 2 1.41-1.41zm3.5-3.5h2v-2h-2v2zm3.5 1.09l2 2h2v-2h-2v-2l-2 2zm-1.41-1.06l-1.06 1.06 1.41 1.41 1.06-1.06-1.41-1.41zm3.5 3.5l2-2 1.41 1.41-2 2-1.41-1.41zm-1.06 1.06l1.06-1.06 1.41 1.41-1.06 1.06-1.41-1.41zM12 18v-2h2v2h-2z" />
          </svg>
        </div>
        <div class="text-4xl font-semibold mb-2">
          <span id="light-value" class="skeleton w-24 h-10 inline-block"></span>
          <span class="ml-2">lux</span>
        </div>
        <p class="text-sm text-gray-400">Atualizado a cada 5 segundos</p>
      </div>

      <!-- Card de Pressão Atmosférica -->
      <div class="card p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Pressão </h2>
          <!-- Ícone de barômetro SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm-1 16.5v-7l5-2v7l-5 2z" />
          </svg>
        </div>
        <div class="text-4xl font-semibold mb-2">
          <span id="pressure-value" class="skeleton w-24 h-10 inline-block"></span>
          <span class="ml-2">hPa</span>
        </div>
        <p class="text-sm text-gray-400">Atualizado a cada 5 segundos</p>
      </div>

      <!-- Card de Qualidade do Ar (CO2) -->
      <div class="card p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Qualidade do Ar</h2>
          <!-- Ícone de folha SVG -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-400" viewBox="0 0 24 24"
            fill="currentColor">
            <path
              d="M12 2c-3.11 0-5.64 2.37-6 5.37C5.54 11.55 12 22 12 22s6.46-10.45 6-14.63C17.64 4.37 15.11 2 12 2zm0 13c-1.1 0-2-0.9-2-2s0.9-2 2-2 2 0.9 2 2-0.9 2-2 2z" />
          </svg>
        </div>
        <div class="text-4xl font-semibold mb-2">
          <span id="air-value" class="skeleton w-24 h-10 inline-block"></span>
          <span class="ml-2">ppm</span>
        </div>
        <p class="text-sm text-gray-400">Atualizado a cada 5 segundos</p>
      </div>

    </div>
  </div>

  <script>
    // Endpoint para o backend (ajuste se necessário)
    const API_DASHBOARD_URL = 'https://localhost:8443/api/sensores/latest';

    // Mapeamento dos tipos de sensores para seus respectivos IDs de HTML.
    const sensorMap = {
      "temperatura": "temp-value",
      "umidade": "humidity-value",
      "luminosidade": "light-value"
    };

    // Mapeamento para os sensores dinâmicos
    const dynamicSensorMap = {
      "pressure-value": { min: 950, max: 1050, decimal: 1 }, // Pressão em hPa
      "air-value": { min: 400, max: 600, decimal: 0 } // Qualidade do ar em ppm
    };

    // Verificação de autenticação e início dos intervalos ao carregar a página
    window.onload = function () {
      const jwtToken = localStorage.getItem('jwtToken');
      if (!jwtToken) {
        // Se não houver token, redireciona para a página de login
        window.location.href = 'login.html';
      }
      // Remove a classe de esqueleto ao carregar a página
      document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));

      // Inicia o carregamento de dados do backend e a atualização dos sensores dinâmicos
      fetchSensorData();
      updateDynamicSensors();
    };

    // Lógica para o botão de logout
    document.getElementById('logout-button').addEventListener('click', () => {
      // Remove o token e redireciona para o login
      localStorage.removeItem('jwtToken');
      window.location.href = 'login.html';
    });

    // Função para buscar dados do backend
    async function fetchSensorData() {
      try {
        const jwtToken = localStorage.getItem('jwtToken');
        const response = await fetch(API_DASHBOARD_URL, {
          headers: { 'Authorization': `Bearer ${jwtToken}` }
        });

        if (!response.ok) {
          throw new Error('Falha ao obter os dados do sensor.');
        }

        const data = await response.json();
        updateDashboard(data);

      } catch (error) {
        console.error("Erro ao buscar dados do sensor:", error);
        document.getElementById('alert-message').textContent = 'Erro ao conectar com o servidor.';
        document.getElementById('alert-message').classList.remove('hidden');
      }
    }

    // Função para atualizar o painel com os dados do backend
    function updateDashboard(data) {
      const alertMessageElement = document.getElementById('alert-message');

      // Verifica se há uma mensagem de alerta e a exibe
      if (data.alertMessage) {
        alertMessageElement.textContent = data.alertMessage;
        alertMessageElement.classList.remove('hidden');
      } else {
        alertMessageElement.classList.add('hidden');
      }

      // Acessa o mapeamento com a chave do sensor em minúsculas
      const sensorNameLower = data.sensor.toLowerCase();
      const sensorId = sensorMap[sensorNameLower];

      if (sensorId) {
        const element = document.getElementById(sensorId);
        if (element) {
          element.textContent = data.valor;
        }
      } else {
        console.warn(`Sensor com nome "${data.sensor}" não encontrado no mapeamento.`);
      }
    }

    // Função para atualizar os sensores dinâmicos
    function updateDynamicSensors() {
      for (const sensorId in dynamicSensorMap) {
        const config = dynamicSensorMap[sensorId];
        const value = (Math.random() * (config.max - config.min) + config.min).toFixed(config.decimal);
        document.getElementById(sensorId).textContent = value;
      }
    }

    // Atualiza os dados do backend e os dinâmicos a cada 5 segundos
    setInterval(fetchSensorData, 5000);
    setInterval(updateDynamicSensors, 5000);
  </script>
</body>

</html>